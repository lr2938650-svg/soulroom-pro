<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SoulRoom üé§</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#f6eaff;
  --card:#ffffff;
  --me:#d7b8ff;
  --other:#f2d8ec;
  --text:#333;
}
.dark{
  --bg:#1c1b2e;
  --card:#2b2650;
  --me:#7c6ae6;
  --other:#403a66;
  --text:#fff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
#login,#chat{
  max-width:520px;
  margin:auto;
  height:100dvh;
  display:flex;
  align-items:center;
}
.card{
  background:var(--card);
  width:100%;
  height:100%;
  border-radius:18px;
  padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  display:flex;
  flex-direction:column;
}
input,textarea,button{
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:16px;
}
button{background:#b388ff;color:#fff}
.roomRow{display:flex;gap:6px}
.roomRow button{width:48px}
#messages{
  flex:1;
  overflow-y:auto;
  padding:8px;
}
.msg{
  max-width:75%;
  padding:10px;
  margin:6px 0;
  border-radius:14px;
}
.me{background:var(--me);margin-left:auto}
.other{background:var(--other)}
audio{width:100%}
.tick{font-size:11px;margin-left:6px}
.inputBar{
  display:flex;
  gap:6px;
  align-items:center;
}
textarea{
  flex:1;
  height:42px;
  resize:none;
}
.smallBtn{
  width:42px;
  height:42px;
  border-radius:50%;
}
.recording{
  background:#ff4d6d !important;
}
#typing{font-size:12px;opacity:.7}
.toggle{position:fixed;top:10px;right:10px}
</style>
</head>

<body>

<button class="toggle" onclick="toggleTheme()">üåô</button>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h2>üíú SoulRoom</h2>
    <input id="name" placeholder="Your Name">
    <div class="roomRow">
      <input id="room" type="password" placeholder="Secret Code">
      <button onclick="toggleRoom()">üëÅÔ∏è</button>
    </div>
    <button onclick="join()">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat" style="display:none">
  <div class="card">
    <div id="messages"></div>
    <div id="typing"></div>

    <div class="inputBar">
      <textarea id="msg" placeholder="Type‚Ä¶"></textarea>
      <button class="smallBtn" onclick="sendText()">‚û§</button>
      <button class="smallBtn" id="micBtn">üé§</button>
    </div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAdpLNU2c-C5KxJv2weJECSpoghz_NGNtM",
  authDomain: "soulroom-4e31d.firebaseapp.com",
  databaseURL: "https://soulroom-4e31d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "soulroom-4e31d",
  storageBucket: "soulroom-4e31d.firebasestorage.app",
  messagingSenderId: "139421380646",
  appId: "1:139421380646:web:8dc4a4e166291102d2f6e7"
});

const db = firebase.database();

const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat");
const nameInput = document.getElementById("name");
const roomInput = document.getElementById("room");
const msgInput = document.getElementById("msg");
const messagesDiv = document.getElementById("messages");
const typingDiv = document.getElementById("typing");
const micBtn = document.getElementById("micBtn");

let user, room, ref;
let recorder = null, chunks = [], stream = null;

/* UI */
function toggleRoom(){ roomInput.type = roomInput.type==="password"?"text":"password"; }
function toggleTheme(){ document.body.classList.toggle("dark"); }

/* Join */
function join(){
 if(!nameInput.value || !roomInput.value) return alert("Fill all fields");
 user = nameInput.value.trim();
 room = roomInput.value.trim();
 ref = db.ref("rooms/"+room+"/messages");

 loginDiv.style.display="none";
 chatDiv.style.display="flex";
 listen();
}

/* Listen */
function listen(){
 ref.on("child_added", s=>{
  const m=s.val();
  const d=document.createElement("div");
  d.className="msg "+(m.user===user?"me":"other");

  if(m.audio){
    const a=document.createElement("audio");
    a.controls=true;
    a.src=m.audio;
    d.appendChild(a);
  }else{
    d.innerText=m.text||"";
  }

  if(m.user===user){
    const t=document.createElement("span");
    t.className="tick";
    t.innerText=m.seen?"‚úî‚úî":"‚úî";
    d.appendChild(t);
  }else{
    s.ref.child("seen").set(true);
  }

  messagesDiv.appendChild(d);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
 });
}

/* Text send */
function sendText(){
 if(!msgInput.value) return;
 const msgRef = ref.push({
  user,
  text: msgInput.value,
  time: Date.now(),
  seen:false
 });
 setTimeout(()=>msgRef.remove(),30000);
 msgInput.value="";
}

/* Typing */
msgInput.oninput=()=>{
 typingDiv.innerText=user+" typing‚Ä¶";
 setTimeout(()=>typingDiv.innerText="",800);
};

/* üé§ WhatsApp-style voice */
micBtn.onclick = async ()=>{
 if(!navigator.mediaDevices) return alert("Mic not supported");

 if(!recorder || recorder.state==="inactive"){
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(stream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
   const blob=new Blob(chunks,{type:"audio/webm"});
   chunks=[];
   const r=new FileReader();
   r.onload=()=>{
    const mref=ref.push({user,audio:r.result,time:Date.now(),seen:false});
    setTimeout(()=>mref.remove(),30000);
   };
   r.readAsDataURL(blob);
   stream.getTracks().forEach(t=>t.stop());
  };
  recorder.start();
  micBtn.classList.add("recording");
 }else{
  recorder.stop();
  micBtn.classList.remove("recording");
 }
};

/* Screenshot / screen detect */
document.addEventListener("visibilitychange",()=>{
 if(document.hidden){
  ref.push({
   user:"System",
   text:"‚ö†Ô∏è Screenshot / screen activity detected",
   time:Date.now()
  });
 }
});
</script>
</body>
</html>
